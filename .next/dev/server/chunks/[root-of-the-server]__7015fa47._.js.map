{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/upload-product-image/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { writeFile, mkdir } from 'fs/promises';\nimport path from 'path';\nimport { existsSync } from 'fs';\n\nexport async function POST(req: NextRequest) {\n  try {\n    const formData = await req.formData();\n    const file = formData.get('file') as File;\n    const productName = formData.get('productName') as string;\n    const productId = formData.get('productId') as string;\n\n    if (!file) {\n      return NextResponse.json(\n        { error: 'Nenhum arquivo enviado' },\n        { status: 400 }\n      );\n    }\n\n    // Validate file type\n    if (!file.type.startsWith('image/')) {\n      return NextResponse.json(\n        { error: 'Por favor, envie uma imagem' },\n        { status: 400 }\n      );\n    }\n\n    // Validate file size (max 5MB)\n    if (file.size > 5 * 1024 * 1024) {\n      return NextResponse.json(\n        { error: 'Imagem muito grande. Máximo 5MB.' },\n        { status: 400 }\n      );\n    }\n\n    // Generate filename based on product name or ID\n    let baseName = '';\n    if (productName && productName.trim() !== '') {\n      // Sanitize name: remove special chars, replace spaces with underscores\n      baseName = productName\n        .toLowerCase()\n        .normalize('NFD')\n        .replace(/[\\u0300-\\u036f]/g, '') // Remove accents\n        .replace(/[^a-z0-9\\s]/g, '') // Keep only alphanumeric and spaces\n        .replace(/\\s+/g, '_') // Replace spaces with underscores\n        .substring(0, 50); // Limit length\n    } else if (productId) {\n      baseName = productId;\n    } else {\n      // Fallback to timestamp if neither name nor ID\n      baseName = `produto_${Date.now()}`;\n    }\n\n    const fileExtension = file.name.split('.').pop() || 'jpg';\n    const fileName = `${baseName}_${Date.now()}.${fileExtension}`;\n    \n    // Ensure directory exists\n    const uploadDir = path.join(process.cwd(), 'public', 'fotos', 'produtos');\n    if (!existsSync(uploadDir)) {\n      await mkdir(uploadDir, { recursive: true });\n    }\n    \n    const filePath = path.join(uploadDir, fileName);\n\n    // Convert file to buffer\n    const bytes = await file.arrayBuffer();\n    const buffer = Buffer.from(bytes);\n\n    // Save to local filesystem\n    await writeFile(filePath, buffer);\n\n    // Return the public URL path\n    const publicPath = `/fotos/produtos/${fileName}`;\n\n    return NextResponse.json({\n      url: publicPath,\n      fileName: fileName,\n      message: 'Imagem salva com sucesso'\n    });\n\n  } catch (error) {\n    console.error('Erro ao fazer upload da imagem:', error);\n    return NextResponse.json(\n      { error: 'Erro ao fazer upload da imagem' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const imagePath = searchParams.get('path');\n\n    if (!imagePath) {\n      return NextResponse.json(\n        { error: 'Caminho de imagem não fornecido' },\n        { status: 400 }\n      );\n    }\n\n    // Security check: only allow deletion from /fotos/produtos/\n    if (!imagePath.startsWith('/fotos/produtos/')) {\n      return NextResponse.json(\n        { error: 'Caminho de imagem inválido' },\n        { status: 400 }\n      );\n    }\n\n    const { unlink } = await import('fs/promises');\n    const filePath = path.join(process.cwd(), 'public', imagePath);\n\n    try {\n      await unlink(filePath);\n    } catch (error) {\n      // File doesn't exist, that's ok\n      console.log('File not found, may have been already deleted:', filePath);\n    }\n\n    return NextResponse.json({\n      message: 'Imagem removida com sucesso'\n    });\n  } catch (error) {\n    console.error('Erro ao remover imagem:', error);\n    return NextResponse.json(\n      { error: 'Erro ao remover imagem' },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}