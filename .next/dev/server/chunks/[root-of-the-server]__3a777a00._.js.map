{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/mobile/tablet-register/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nfunction getSupabase() {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n  \n  if (!supabaseUrl || !supabaseKey) {\n    throw new Error('Supabase credentials not configured')\n  }\n  \n  return createClient(supabaseUrl, supabaseKey)\n}\n\nexport async function GET(request: NextRequest) {\n  const supabase = getSupabase()\n  try {\n    const deviceId = request.nextUrl.searchParams.get('device_id')\n    \n    if (!deviceId) {\n      return NextResponse.json(\n        { error: 'device_id é obrigatório' },\n        { status: 400 }\n      )\n    }\n\n    const { data: tablet, error } = await supabase\n      .from('registered_tablets')\n      .select('*')\n      .eq('device_id', deviceId)\n      .single()\n\n    if (error && error.code !== 'PGRST116') {\n      throw error\n    }\n\n    if (tablet) {\n      await supabase\n        .from('registered_tablets')\n        .update({ last_seen: new Date().toISOString() })\n        .eq('device_id', deviceId)\n\n      return NextResponse.json({\n        registered: true,\n        tablet: {\n          id: tablet.id,\n          name: tablet.name,\n          device_id: tablet.device_id,\n          status: tablet.status\n        }\n      })\n    }\n\n    const { data: maxTabletsSetting } = await supabase\n      .from('tablet_settings')\n      .select('setting_value')\n      .eq('setting_key', 'max_tablets')\n      .single()\n\n    const maxTablets = parseInt(maxTabletsSetting?.setting_value || '20')\n\n    const { count } = await supabase\n      .from('registered_tablets')\n      .select('*', { count: 'exact', head: true })\n\n    const currentCount = count || 0\n    const slotsAvailable = currentCount < maxTablets\n\n    return NextResponse.json({\n      registered: false,\n      slots_available: slotsAvailable,\n      current_count: currentCount,\n      max_tablets: maxTablets\n    })\n\n  } catch (error: any) {\n    console.error('Erro ao verificar registro do tablet:', error)\n    return NextResponse.json(\n      { error: 'Erro ao verificar registro' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const supabase = getSupabase()\n  try {\n    const body = await request.json()\n    const { device_id, name, ip_address } = body\n\n    if (!device_id) {\n      return NextResponse.json(\n        { error: 'device_id é obrigatório' },\n        { status: 400 }\n      )\n    }\n\n    const { data: existing } = await supabase\n      .from('registered_tablets')\n      .select('id')\n      .eq('device_id', device_id)\n      .single()\n\n    if (existing) {\n      await supabase\n        .from('registered_tablets')\n        .update({ \n          last_seen: new Date().toISOString(),\n          ip_address: ip_address || null\n        })\n        .eq('device_id', device_id)\n\n      return NextResponse.json({\n        success: true,\n        message: 'Tablet já registrado, último acesso atualizado'\n      })\n    }\n\n    const { data: maxTabletsSetting } = await supabase\n      .from('tablet_settings')\n      .select('setting_value')\n      .eq('setting_key', 'max_tablets')\n      .single()\n\n    const maxTablets = parseInt(maxTabletsSetting?.setting_value || '20')\n\n    const { count } = await supabase\n      .from('registered_tablets')\n      .select('*', { count: 'exact', head: true })\n\n    const currentCount = count || 0\n\n    if (currentCount >= maxTablets) {\n      return NextResponse.json(\n        { \n          error: 'Limite de tablets atingido',\n          message: 'Não há mais vagas disponíveis para registro de tablets. Entre em contato com o administrador.',\n          current_count: currentCount,\n          max_tablets: maxTablets\n        },\n        { status: 403 }\n      )\n    }\n\n    const tabletNumber = currentCount + 1\n    const tabletName = name || `Tablet ${tabletNumber}`\n\n    const { data: newTablet, error: insertError } = await supabase\n      .from('registered_tablets')\n      .insert({\n        device_id,\n        name: tabletName,\n        ip_address: ip_address || null,\n        status: 'active',\n        registered_at: new Date().toISOString(),\n        last_seen: new Date().toISOString()\n      })\n      .select()\n      .single()\n\n    if (insertError) throw insertError\n\n    return NextResponse.json({\n      success: true,\n      message: 'Tablet registrado com sucesso!',\n      tablet: {\n        id: newTablet.id,\n        name: newTablet.name,\n        device_id: newTablet.device_id,\n        status: newTablet.status\n      }\n    })\n\n  } catch (error: any) {\n    console.error('Erro ao registrar tablet:', error)\n    return NextResponse.json(\n      { error: 'Erro ao registrar tablet' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,SAAS;IACP,MAAM;IACN,MAAM,cAAc,QAAQ,GAAG,CAAC,yBAAyB;IAEzD,IAAI,CAAC,eAAe,CAAC,aAAa;QAChC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,yMAAY,EAAC,aAAa;AACnC;AAEO,eAAe,IAAI,OAAoB;IAC5C,MAAM,WAAW;IACjB,IAAI;QACF,MAAM,WAAW,QAAQ,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;QAElD,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,MAAM,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACnC,IAAI,CAAC,sBACL,MAAM,CAAC,KACP,EAAE,CAAC,aAAa,UAChB,MAAM;QAET,IAAI,SAAS,MAAM,IAAI,KAAK,YAAY;YACtC,MAAM;QACR;QAEA,IAAI,QAAQ;YACV,MAAM,SACH,IAAI,CAAC,sBACL,MAAM,CAAC;gBAAE,WAAW,IAAI,OAAO,WAAW;YAAG,GAC7C,EAAE,CAAC,aAAa;YAEnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,YAAY;gBACZ,QAAQ;oBACN,IAAI,OAAO,EAAE;oBACb,MAAM,OAAO,IAAI;oBACjB,WAAW,OAAO,SAAS;oBAC3B,QAAQ,OAAO,MAAM;gBACvB;YACF;QACF;QAEA,MAAM,EAAE,MAAM,iBAAiB,EAAE,GAAG,MAAM,SACvC,IAAI,CAAC,mBACL,MAAM,CAAC,iBACP,EAAE,CAAC,eAAe,eAClB,MAAM;QAET,MAAM,aAAa,SAAS,mBAAmB,iBAAiB;QAEhE,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,sBACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK;QAE5C,MAAM,eAAe,SAAS;QAC9B,MAAM,iBAAiB,eAAe;QAEtC,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,YAAY;YACZ,iBAAiB;YACjB,eAAe;YACf,aAAa;QACf;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yCAAyC;QACvD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA6B,GACtC;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,MAAM,WAAW;IACjB,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,GAAG;QAExC,IAAI,CAAC,WAAW;YACd,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,SAC9B,IAAI,CAAC,sBACL,MAAM,CAAC,MACP,EAAE,CAAC,aAAa,WAChB,MAAM;QAET,IAAI,UAAU;YACZ,MAAM,SACH,IAAI,CAAC,sBACL,MAAM,CAAC;gBACN,WAAW,IAAI,OAAO,WAAW;gBACjC,YAAY,cAAc;YAC5B,GACC,EAAE,CAAC,aAAa;YAEnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS;YACX;QACF;QAEA,MAAM,EAAE,MAAM,iBAAiB,EAAE,GAAG,MAAM,SACvC,IAAI,CAAC,mBACL,MAAM,CAAC,iBACP,EAAE,CAAC,eAAe,eAClB,MAAM;QAET,MAAM,aAAa,SAAS,mBAAmB,iBAAiB;QAEhE,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SACrB,IAAI,CAAC,sBACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK;QAE5C,MAAM,eAAe,SAAS;QAE9B,IAAI,gBAAgB,YAAY;YAC9B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,OAAO;gBACP,SAAS;gBACT,eAAe;gBACf,aAAa;YACf,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,eAAe,eAAe;QACpC,MAAM,aAAa,QAAQ,CAAC,OAAO,EAAE,cAAc;QAEnD,MAAM,EAAE,MAAM,SAAS,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACnD,IAAI,CAAC,sBACL,MAAM,CAAC;YACN;YACA,MAAM;YACN,YAAY,cAAc;YAC1B,QAAQ;YACR,eAAe,IAAI,OAAO,WAAW;YACrC,WAAW,IAAI,OAAO,WAAW;QACnC,GACC,MAAM,GACN,MAAM;QAET,IAAI,aAAa,MAAM;QAEvB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT,QAAQ;gBACN,IAAI,UAAU,EAAE;gBAChB,MAAM,UAAU,IAAI;gBACpB,WAAW,UAAU,SAAS;gBAC9B,QAAQ,UAAU,MAAM;YAC1B;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA2B,GACpC;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}