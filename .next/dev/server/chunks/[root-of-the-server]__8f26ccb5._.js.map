{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/printers/discover/route.ts"],"sourcesContent":["// API para descobrir impressoras na rede local\nimport { NextResponse } from \"next/server\";\n\n// IPs e portas comuns para impressoras t√©rmicas\nconst COMMON_PRINTER_PORTS = [9100, 515, 631, 3910];\nconst COMMON_PRINTER_IPS = [\n  '192.168.1.', '192.168.0.', '10.0.0.', '172.16.0.'\n];\n\n// Verificar se um IP responde em uma porta espec√≠fica\nasync function checkPort(ip: string, port: number): Promise<boolean> {\n  return new Promise((resolve) => {\n    const net = require('net');\n    const socket = new net.Socket();\n    const timeout = setTimeout(() => {\n      socket.destroy();\n      resolve(false);\n    }, 500); // 500ms timeout para cada tentativa\n    \n    socket.connect(port, ip, () => {\n      clearTimeout(timeout);\n      socket.destroy();\n      resolve(true);\n    });\n    \n    socket.on('error', () => {\n      clearTimeout(timeout);\n      resolve(false);\n    });\n  });\n}\n\n// Descobrir impressoras na rede\nasync function discoverPrinters(subnet: string): Promise<any[]> {\n  const foundPrinters: any[] = [];\n  const promises: Promise<void>[] = [];\n  \n  // Varrer IPs comuns (√∫ltimos 20 IPs da subnet)\n  for (let i = 100; i <= 120; i++) {\n    const ip = `${subnet}${i}`;\n    \n    promises.push(\n      (async () => {\n        for (const port of COMMON_PRINTER_PORTS) {\n          const isOpen = await checkPort(ip, port);\n          if (isOpen) {\n            foundPrinters.push({\n              ip,\n              port,\n              name: `Impressora em ${ip}`,\n              model: 'Detectada Automaticamente',\n              status: 'online'\n            });\n            break; // Encontrou em uma porta, n√£o precisa testar outras\n          }\n        }\n      })()\n    );\n  }\n  \n  // Aguardar todas as verifica√ß√µes\n  await Promise.all(promises);\n  \n  return foundPrinters;\n}\n\nexport async function GET(request: Request) {\n  try {\n    console.log('üîç Iniciando descoberta de impressoras na rede...');\n    \n    const allFoundPrinters: any[] = [];\n    \n    // Tentar descobrir em subnets comuns\n    for (const subnet of COMMON_PRINTER_IPS) {\n      const printers = await discoverPrinters(subnet);\n      allFoundPrinters.push(...printers);\n    }\n    \n    // Adicionar impressoras conhecidas (para teste)\n    const knownPrinters = [\n      {\n        ip: '192.168.1.101',\n        port: 9100,\n        name: 'Virtual Cozinha',\n        model: 'Bematech MP-4200 TH',\n        status: 'virtual',\n        isVirtual: true\n      },\n      {\n        ip: '192.168.1.102',\n        port: 9100,\n        name: 'Virtual Bar',\n        model: 'Bematech MP-4200 TH',\n        status: 'virtual',\n        isVirtual: true\n      },\n      {\n        ip: '192.168.1.103',\n        port: 9100,\n        name: 'Virtual Caixa',\n        model: 'Bematech MP-4200 TH',\n        status: 'virtual',\n        isVirtual: true\n      },\n      {\n        ip: '192.168.1.104',\n        port: 9100,\n        name: 'Virtual Sushi Bar',\n        model: 'Bematech MP-4200 TH',\n        status: 'virtual',\n        isVirtual: true\n      }\n    ];\n    \n    // Combinar impressoras descobertas com as conhecidas\n    const allPrinters = [...allFoundPrinters, ...knownPrinters];\n    \n    console.log(`‚úÖ Descoberta conclu√≠da. ${allFoundPrinters.length} impressoras reais encontradas`);\n    \n    return NextResponse.json({\n      success: true,\n      discovered: allFoundPrinters.length,\n      virtual: knownPrinters.length,\n      total: allPrinters.length,\n      printers: allPrinters\n    });\n    \n  } catch (error: any) {\n    console.error('‚ùå Erro na descoberta de impressoras:', error);\n    return NextResponse.json(\n      { \n        success: false, \n        error: error.message || \"Erro ao descobrir impressoras\"\n      },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"AAAA,+CAA+C;;;;;AAC/C;;AAEA,gDAAgD;AAChD,MAAM,uBAAuB;IAAC;IAAM;IAAK;IAAK;CAAK;AACnD,MAAM,qBAAqB;IACzB;IAAc;IAAc;IAAW;CACxC;AAED,sDAAsD;AACtD,eAAe,UAAU,EAAU,EAAE,IAAY;IAC/C,OAAO,IAAI,QAAQ,CAAC;QAClB,MAAM;QACN,MAAM,SAAS,IAAI,IAAI,MAAM;QAC7B,MAAM,UAAU,WAAW;YACzB,OAAO,OAAO;YACd,QAAQ;QACV,GAAG,MAAM,oCAAoC;QAE7C,OAAO,OAAO,CAAC,MAAM,IAAI;YACvB,aAAa;YACb,OAAO,OAAO;YACd,QAAQ;QACV;QAEA,OAAO,EAAE,CAAC,SAAS;YACjB,aAAa;YACb,QAAQ;QACV;IACF;AACF;AAEA,gCAAgC;AAChC,eAAe,iBAAiB,MAAc;IAC5C,MAAM,gBAAuB,EAAE;IAC/B,MAAM,WAA4B,EAAE;IAEpC,+CAA+C;IAC/C,IAAK,IAAI,IAAI,KAAK,KAAK,KAAK,IAAK;QAC/B,MAAM,KAAK,GAAG,SAAS,GAAG;QAE1B,SAAS,IAAI,CACX,CAAC;YACC,KAAK,MAAM,QAAQ,qBAAsB;gBACvC,MAAM,SAAS,MAAM,UAAU,IAAI;gBACnC,IAAI,QAAQ;oBACV,cAAc,IAAI,CAAC;wBACjB;wBACA;wBACA,MAAM,CAAC,cAAc,EAAE,IAAI;wBAC3B,OAAO;wBACP,QAAQ;oBACV;oBACA,OAAO,oDAAoD;gBAC7D;YACF;QACF,CAAC;IAEL;IAEA,iCAAiC;IACjC,MAAM,QAAQ,GAAG,CAAC;IAElB,OAAO;AACT;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,QAAQ,GAAG,CAAC;QAEZ,MAAM,mBAA0B,EAAE;QAElC,qCAAqC;QACrC,KAAK,MAAM,UAAU,mBAAoB;YACvC,MAAM,WAAW,MAAM,iBAAiB;YACxC,iBAAiB,IAAI,IAAI;QAC3B;QAEA,gDAAgD;QAChD,MAAM,gBAAgB;YACpB;gBACE,IAAI;gBACJ,MAAM;gBACN,MAAM;gBACN,OAAO;gBACP,QAAQ;gBACR,WAAW;YACb;YACA;gBACE,IAAI;gBACJ,MAAM;gBACN,MAAM;gBACN,OAAO;gBACP,QAAQ;gBACR,WAAW;YACb;YACA;gBACE,IAAI;gBACJ,MAAM;gBACN,MAAM;gBACN,OAAO;gBACP,QAAQ;gBACR,WAAW;YACb;YACA;gBACE,IAAI;gBACJ,MAAM;gBACN,MAAM;gBACN,OAAO;gBACP,QAAQ;gBACR,WAAW;YACb;SACD;QAED,qDAAqD;QACrD,MAAM,cAAc;eAAI;eAAqB;SAAc;QAE3D,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,iBAAiB,MAAM,CAAC,8BAA8B,CAAC;QAE9F,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,YAAY,iBAAiB,MAAM;YACnC,SAAS,cAAc,MAAM;YAC7B,OAAO,YAAY,MAAM;YACzB,UAAU;QACZ;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO,MAAM,OAAO,IAAI;QAC1B,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}